<style>

</style>

<TMPL_IF FORM>

<body>
<!--<form method="post" name="main_form" id="main_form" accept-charset="utf-8" data-ajax="false" action="./index.cgi" onsubmit="return false;">-->
<form method="post" name="main_form" id="main_form" accept-charset="utf-8" data-ajax="false" action="./index.cgi?form"">

<input type="hidden" name="saveformdata" value="1">
<a type="hidden "id="existingLink" href="/opt/loxberry/data/plugins/owntracks4lox/"></a>
<!--<input type="test" name="test" value="<TMPL_VAR CONNECTION.compare>">-->


<div class="form-group">

<!-- Header-->

<input type="hidden" name="locationdata" value="<TMPL_VAR LOCATION.locationdata>">
<table class="formtable" border="0" width="100%" cellpadding="10">
	<tr>
		<div class="recorder" style="display:flex;align-items:center;justify-content:center;">
			<span id="recorderstate"></span>&nbsp;|
		</div>
		<div class="gate" style="display:flex;align-items:center;justify-content:center;">
			&nbsp;<span id="gatewaystate"></span>&nbsp;| 
			&nbsp;<span id="mosquittostate"></span>&nbsp; &nbsp;
			<!--&nbsp;<font COLOR="blue"><TMPL_VAR SAVE></font>-->
		</div>
		<div class="wide">
		<img width="64" height="64" src="/plugins/<TMPL_VAR PLUGINDIR>/images/owntracks_64.png" alt="">
		<TMPL_VAR BASIC.PLUGIN_NAME>
		</div>
		
		

		
	</tr>
	<tr>
		<td valign="left" style="height: 33px; width: 32%; text-align: left;">
			<h2><TMPL_VAR MENU.IT></h2>
		</td>
	</tr>
	
	<tr>
	<td colspan=3 valign="middle" style="height: 36px">
		<TMPL_IF NAME="locationdata">
			<font size="-1"><TMPL_VAR MENU.IT_TEXT2></font>
		<TMPL_ELSE>
			<font size="-1"><TMPL_VAR MENU.IT_TEXT1></font>
		</TMPL_IF>
	</td>
</tr>

<tr>

<!-- Basiskonfiguration-->

		<table>
			<td valign="left" style="height: 33px; width: 4%; vertical-align: bottom; text-align: left;">
				<label id="lip"><TMPL_VAR MENU.LABEL_IT></label>
			</td>
			<td valign="left" style="height: 33px; width: 11%; text-align: left;">
				<input id="dyndns" name="dyndns" type="text" class="textfield" placeholder="<TMPL_VAR MENU.DYN_DNS_PROVIDER>" value="<TMPL_VAR CONNECTION.dyndns>"
					data-validation-rule="special:domainname_or_ipaddr"
					data-validation-error-msg="<TMPL_VAR VALIDATION.DYNDNS>">
			</td>
			<td valign="left" style="height: 33px; width: 6%; text-align: left;">			
				<!--<input id="port" name="port" type="text" class="textfield" placeholder="TCP Port" value="<TMPL_VAR CONNECTION.port>" disabled=disabled"-->
				<input id="port" name="port" type="text" class="textfield" placeholder="TCP Port" value="<TMPL_VAR CONNECTION.port>"
					data-validation-rule="special:port"
					data-validation-error-msg="<TMPL_VAR VALIDATION.DYNDNS_PORT>">
			</td>
			
			<!--<td valign="left" style="height: 33px; width: 4%; vertical-align: bottom; text-align: left;">			
				<fieldset>
					<select id="tls" name="tls" data-role="flipswitch" style="width: 34px">
						<option <TMPL_VAR TLS1> value="false"><TMPL_VAR BUTTON.FLIPSWITCH_OFF></option>
						<option <TMPL_VAR TLS2> value="true"><TMPL_VAR BUTTON.FLIPSWITCH_ON></option>
					</select>
				</fieldset>
				<script>
					$('#tls').val('<TMPL_VAR CONNECTION.tls>')
				</script>
			</td>-->
			
			<td valign="right" style="height: 33px; width: 4%; vertical-align: bottom; text-align: left;">
			<label id="lip"><TMPL_VAR MENU.LABEL_LOCATION></label>
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
			<input id="location" name="location" type="text" class="textfield" placeholder="<TMPL_VAR MENU.LOCATION>" value="<TMPL_VAR LOCATION.location>"
					data-validation-rule="^([A-Za-z0-9_-]){3,20}$"
					data-validation-error-msg="<TMPL_VAR VALIDATION.ERROR_LOCATION>">			
			</td>
			<td valign="left" style="height: 33px; width: 3%; text-align: left;">
			<input id="radius" name="radius" type="text" class="textfield" placeholder="<TMPL_VAR MENU.RADIUS>" value="<TMPL_VAR LOCATION.radius>"
					data-validation-rule="^[0-9]+(\.[0-9]{2,4})?$"
					data-validation-error-msg="<TMPL_VAR VALIDATION.ERROR_RADIUS>">			
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
			<input id="latitude" name="latitude" type="text" class="textfield" placeholder="<TMPL_VAR MENU.LATITUDE>" value="<TMPL_VAR LOCATION.latitude>"
					data-validation-rule="^-?[0-9]+(\.[0-9]{1,17})?$"
					data-validation-error-msg="<TMPL_VAR VALIDATION.ERROR_LATITUDE>">			
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
			<input id="longitude" name="longitude" type="text" class="textfield" placeholder="<TMPL_VAR MENU.LONGITUDE>" value="<TMPL_VAR LOCATION.longitude>"
					data-validation-rule="^-?[0-9]+(\.[0-9]{1,17})?$"
					data-validation-error-msg="<TMPL_VAR VALIDATION.ERROR_LONGITUDE>">			
			</td>
		</table>
			
			
		<tr>
		<table>
			<td valign="left" style="height: 33px; width: 5%; vertical-align: bottom; text-align: left;">
				<label id="lip"><TMPL_VAR MENU.LABEL_TRACK></label>
			</td>
			<td valign="left" style="height: 33px; width: 2%; text-align: left;">
				
				<fieldset style="width: 101px">
					<select type="checkbox" data-theme="b" id="track" name="track" data-role="flipswitch" style="width: 34px">
						<option <TMPL_VAR TRACK> value="false"><TMPL_VAR BUTTON.FLIPSWITCH_OFF></option>
						<option <TMPL_VAR TRACK> value="true"><TMPL_VAR BUTTON.FLIPSWITCH_ON></option>
					</select>
				</fieldset>
				<script>
					$('#track').val('<TMPL_VAR CONNECTION.track>')
				</script>

			</td>
			<td class="api" valign="left" style="height: 33px; width: 12%; text-align: left;">
				<!--<input id="googleapikey" name="googleapikey" class="textfield" type="text" placeholder="<TMPL_VAR MENU.GOOGLE_KEY>" value="<TMPL_VAR RECORDER_HTTP.OTR_BROWSERAPIKEY>"
					data-validation-error-msg="<TMPL_VAR ERRORS.ERR_SECRETKEY>" 
					data-validation-rule="^([A-Za-z0-9\!\#\$\%\&\'\*\+\_\-\,\/\:\;\=\?\@\[\]\\\]]){0,39}$">-->
				<input id="googleapikey" name="googleapikey" type="text" class="textfield" placeholder="<TMPL_VAR MENU.GOOGLE_KEY>" value="<TMPL_VAR RECORDER_HTTP.OTR_BROWSERAPIKEY>">
			</td>
			<td valign="middle" style="height: 33px; width: 6%; vertical-align: bottom; text-align: left;">
				<label id="lip"><TMPL_VAR MENU.LABEL_TLS></label>
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
				<fieldset>
					<select id="tls" name="tls" data-role="flipswitch" style="width: 34px" disabled=disabled>
						<option <TMPL_VAR TLS1> value="false"><TMPL_VAR BUTTON.FLIPSWITCH_OFF></option>
						<option <TMPL_VAR TLS2> value="true"><TMPL_VAR BUTTON.FLIPSWITCH_ON></option>
					</select>
				</fieldset>
				<script>
					$('#tls').val('<TMPL_VAR CONNECTION.tls>')
				</script>
			</td>
			<td valign="left" style="height: 33px; width: 3%; text-align: left;">
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
			</td>
			<td valign="left" style="height: 33px; width: 5%; text-align: left;">
			</td>
			
		</table>
		<!--<center>
		<a name="btnot" id="btnot" data-role="button" data-inline="true" data-mini="true" data-icon="check"><TMPL_VAR BUTTON.SAVE_CONFIG></a>	
		</center>-->
</tr>
<hr/>

<!-- End Basiskonfiguration-->

	<tr>
		<td valign="left" style="height: 33px; width: 15%; text-align: left;">
			<h2><TMPL_VAR MENU.USER></h2>
		</td>
	</tr>
	<tr>
	<td colspan=3 valign="middle" style="height: 36px">
		<font size="-1"><TMPL_VAR MENU.LOCATION_TEXT></font>
	</td>
	</tr>

	
<!-- End Header-->

	

<!-- Fields User-->
		<tr>
			<table border=0 width="100%">
				<tr>
					<tr>
						<table id="users" name="users" border=0 style="width: 100%">
							<th align="center" style="width: 4%">
							<img class='ico_delete' src='/plugins/<TMPL_VAR PLUGINDIR>/images/recycle-bin.png' align="center" border='0' width='24' height='24'></th>
						    <th align="left" style="height: 33px; width: 22%;"><TMPL_VAR MENU.USERNAME></th>
						    <th align="left" style="height: 33px; width: 4%;"><TMPL_VAR MENU.CONFIG_FILE>
							</th>
							<tbody>
								<div name="userdyn" id="userdyn">
									<TMPL_VAR ROWSUSER>
								</div>
							</tbody>
						</table>
					</tr>
			</table>
			<td style="height: 30px; width: 201px;">
			</td>
			<td style="height: 30px; width: 24px;">
			</td>
		</tr>
</table>

<!-- End Fields User-->

<!-- Fields New line-->

<tr>
	<table>
		<!--<center>-->
			<td valign="middle" style="height: 33px; width: 30%; text-align: middle;">
				<INPUT type="button" value="<TMPL_VAR BUTTON.ADD_USER>" data-inline="true" data-mini="true" data-icon="plus" onclick="AddUser()">
			</td>
		<!--center>-->
			<td  class="legend" valign="middle" style="height: 33px; width: 80px; text-align: middle;">
			</td>
			<td  class="legend" valign="middle" style="height: 33px; width: 8px; text-align: middle;">
				<img src="/plugins/<TMPL_VAR PLUGINDIR>/images/red.png">
			</td>
			<td class="legend" valign="middle" style="height: 33px; width: 280px; text-align: middle;">
				<label id="lred"><TMPL_VAR VALIDATION.LEGEND_RED></label>
			</td>
			<td class="legend" valign="middle" style="height: 33px; width: 8px; text-align: middle;">
				<img src="/plugins/<TMPL_VAR PLUGINDIR>/images/yellow.png">
			</td>	
			<td class="legend" valign="middle" style="height: 33px; width: 280px; text-align: middle;">
				<label id="lred"><TMPL_VAR VALIDATION.LEGEND_YELLOW></label>
			</td>
			<td class="legend" valign="middle" style="height: 33px; width: 8px; text-align: middle;">
				<img src="/plugins/<TMPL_VAR PLUGINDIR>/images/green.png">
			</td>	
			<td class="legend" valign="middle" style="height: 33px; width: 280px; text-align: middle;">
				<label id="lred"><TMPL_VAR VALIDATION.LEGEND_GREEN></label>
			</td>
	
	</table>
</tr>

<!-- End Fields New line-->


<hr/>

</div>

<tr>
<p>
	<center>
		<button type="submit" form="main_form" name="btnsubmit" id="btnsubmit" data-role="button" data-inline="true" data-mini="true" data-icon="check"><TMPL_VAR BUTTON.SAVE_USER></button>
		<a  id="restart" name="restart" data-role="button" data-inline="true" data-mini="true" data-icon="refresh"><TMPL_VAR BUTTON.RESTART></a>
		<div id="log"></div>
	</center>
</p> 
</tr>

</form>
</body>

<script>

$(document).on('pageinit', function() {
	track_on();
});



function track_on()  {
	var trackvalue = $('#track').val();
	if (trackvalue == "true" ) {
  		$('#restart').fadeIn(600);
  		$('.api').fadeIn(600);
  		$('.legend').fadeIn(600);
  		$('.picture').fadeIn(600);
  		$('.recorder').fadeIn(600);
		$('.UUID').fadeIn(600);
 	} else {
  		$('#restart').fadeOut(600);
  		$('.api').fadeOut(600);
  		$('.legend').fadeOut(600);
  		$('.picture').fadeOut(600);
  		$('.recorder').fadeOut(600);
		$('.UUID').fadeOut(600);
  	}
}


// Function to add new User to config
function AddUser() {

  // Total number of User
  var iteration = document.getElementById('countuser').value;
  iteration = parseInt(iteration)
  var tbl = document.getElementById('users');

  // Del 1. row if there where no User
  if ( iteration < 1 ) {
    var row = tbl.deleteRow(-1);
  }
  var lastRow = tbl.rows.length;
  iteration += 1;
  document.getElementById("countuser").value = iteration;
  // Add cells
  var row = tbl.insertRow(lastRow);
  var cellRight = row.insertCell(0);
  cellRight.innerHTML = '<tr><td style="width: 4%"><INPUT type="checkbox" style="width: 100%" name="chkuser' + iteration + '" id="chkuser' + iteration + '" align="center"/></td>\n'
  var cellRight = row.insertCell(1);
  cellRight.innerHTML = '<td style="width: 22%"><input id="username' + iteration + '" name="username' + iteration + '" type="text" placeholder="<TMPL_VAR MENU.USER_LISTING>" value="" align="left" data-validation-error-msg="<TMPL_VAR VALIDATION.USER_NAME>" data-validation-rule="^([äöüÖÜßÄ A-Za-z0-9\ ]){1,20}" style="width: 100%;"></td>\n'
  var cellRight = row.insertCell(2);
  cellRight.innerHTML = '<td style="width: 4%"><font size="3" color="green"><TMPL_VAR BUTTON.SAVE_CONFIG_MESSAGE></font></td>\n'
  var cellRight = row.insertCell(3);
  cellRight.innerHTML = '<img src="/plugins/<TMPL_VAR PLUGINDIR>/images/red.png" id="tra' + iteration + '" name="tra' + iteration + '">\n'  
  console.log("New row inserted. New countuser=" + iteration + "");
  $('input[type=text].countuser').val(iteration);		
  $("#main_form").trigger('create');

}

// Update Pids from index.cgi
function update_pids() {
	
	$.post( 'index.cgi', {
	ajax: 'getpids' })

	.done(function(resp) {
		console.log( "ajax_post", "success", resp );
		if(resp.pids.recorder != null) {
			$("#recorderstate").attr("style", "color:green").html("Tracking running (PID"+resp.pids.recorder+")");
		} else {
			$("#recorderstate").attr("style", "color:red").html("Tracking not running or restarting");
		}
		if(resp.pids.mqttgateway != null) {
			$("#gatewaystate").attr("style", "color:green").html("MQTT Gateway running (PID"+resp.pids.mqttgateway+")");
		} else {
			$("#gatewaystate").attr("style", "color:red").html("MQTT Gateway not running");
		}
		if(resp.pids.mosquitto != null) {
			$("#mosquittostate").attr("style", "color:green").html("Mosquitto running (PID"+resp.pids.mosquitto+")");
		} else {
			$("#mosquittostate").attr("style", "color:red").html("Mosquitto not running");
		}
		
	})
	.fail(function(resp) {
		$("#recorderstate").attr("style", "color:red").html("Failed to query PID");
		console.log( "ajax_post", "error", resp );
	})
	.always(function(resp) {
		//console.log( "ajax_post", "finished", resp );
	});
}
	
	
// Restart Tracking (ot recorder)
$(function() {

$("#restart").click(function(){
		console.log("Restart pressed");
		$("#restart").attr("disabled", true);
		$.post( 'index.cgi', {
		ajax: 'restartrecorder' })
		
		.done(function(resp) {
			console.log( "ajax_post", "success", resp );
	  })
	  .fail(function(resp) {
			console.log( "ajax_post", "failed", resp );
	  })
	  .always(function(resp) {
			console.log( "ajax_post", "finished", resp );
		$("#restart").attr("disabled", false);
		update_pids();
		url = './index.cgi?do=restarttracking';
		document.location.href = url;	
	  });
	});
});


$(document).ready( function ()  {
		$("form#main_form").submit(function(e) {
			
		});	
		setInterval(function(){ update_pids(); }, 5000);
		update_pids();
		
		// form validation
		var iteration = document.getElementById('countuser').value;
		iteration = parseInt(iteration)
		iteration += 1;
		for (i = 1; i < iteration; ++i) {
		//console.log('#UUID' + i + '');
		//var trackvalue = $('#track').val();
			validate_enable('#username' + i + '');
			//if (document.getElementById('#UUID' + i + ''))   {
			validate_chk_object(['#username' + i + '']);
			//} else {
			//	validate_enable('#UUID' + i + '');
			//	validate_enable('#uuidmajor' + i + '');
			//	validate_enable('#uuidminor' + i + '');
			//	validate_chk_object(['#username' + i + '','#UUID' + i + '','#uuidmajor' + i + '','#uuidminor' + i + '']);
			//}
			//validate_chk_object(['#username' + i + '','#UUID' + i + '','#uuidmajor' + i + '','#uuidminor' + i + '']);
			
			console.log('#username' + i + '');
		}
		validate_enable('#dyndns');
		validate_enable('#port');
		validate_enable('#location');
		validate_enable('#radius');
		validate_enable('#latitude');
		validate_enable('#longitude');
		validate_chk_object(['#dyndns','#port','#location','#radius','#latitude','#longitude']);
		$("#main_form").trigger('create');
		
    
		// Fade In/-Out fields depending on Track On/Off
		$('#track').on('change',function(){
			track_on();
		});  
	

 
});
	

</script>

</TMPL_IF>

<TMPL_IF COMMAND>

<div class="wide">
	<img width="64" height="64" src="/plugins/<TMPL_VAR PLUGINDIR>/images/owntracks_64.png" alt="">
	<TMPL_VAR BASIC.PLUGIN_NAME>
		</div>
			<table border=0>
				<tr>
					<td align="left" style="width: 1258px">
							<tr>
								<td valign="left" style="height: 36px; width: 100%;">
									<font size="+1"><TMPL_VAR COMMAND.HTTP_MS></font>
								</td>
							</tr>
							<tr>
								<td valign="left" style="height: 36px; width: 100%;">
									<font size="-1"><TMPL_VAR COMMAND.HTTP_MS_TEXT></font>
								</td>
							</tr>
							<TMPL_VAR http_table>
							<br/>
							<hr/>
							<tr>
								<td valign="left" style="height: 36px; width: 100%;">
									<font size="+1"><TMPL_VAR COMMAND.UDP_MS></font>
								</td>
							</tr>
							<tr>
							<br/><br/>
								<td valign="left" style="height: 36px; width: 100%;">
									<font size="-1"><TMPL_VAR COMMAND.UDP_MS_TEXT></font>
								</td>
							</tr>
							<TMPL_VAR udp_table>
							<br/>
							<hr/>
					</td>
				</tr>
			</table>
</TMPL_IF>


<TMPL_IF LOGFILES>
<!-- form 'LOGFILES' START -->
	<TMPL_VAR LOGLIST_HTML>
<!-- form 'LOGFILES' END -->
</TMPL_IF LOGFILES>

<TMPL_IF SAVE>
    <center>
        <table border=0>
            <tr>
                <td align="center">
                    <h2>
                        <TMPL_VAR SAVE.SAVE_ALL_OK>
                    </h2>
                    <p>
                        <TMPL_VAR SAVE.SAVE_MESSAGE>
                    </p>
					
					<p>
                        <TMPL_VAR SAVE.SAVE_USERFILES>
                    </p>
					<p>
					<FONT COLOR="blue">
                        <TMPL_VAR SAVE.SAVE_FODLERFILES>
					</FONT>	
					</p>
					<br>
					<p>
					<FONT COLOR="#FF0000">
						<TMPL_VAR OT_MESSAGE>
					</FONT>
                    </p>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <p>
                        <a id="btnok" data-role="button" data-inline="true" data-mini="true" data-icon="check" href="./index.cgi">
                            <TMPL_VAR SAVE.SAVE_BUTTON_OK>
                        </a>
                    </p>
                </td>
            </tr>
        </table>
    </center>
</TMPL_IF>


<TMPL_IF ERROR>
    <center>
        <table border=0>
            <tr>
                <td align="center">
                    <h2>
                        <FONT COLOR="#FF0000">
                            <TMPL_VAR ERRORS.ERR_TITLE>
                        </FONT>
                    </h2>
                    <p>
                        <TMPL_VAR ERR_MESSAGE>
                    </p>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <p>
                        <a id="btnok" data-role="button" data-inline="true" data-mini="true" data-icon="check" href="./index.cgi">
                            <TMPL_VAR ERRORS.ERR_BUTTON_BACK>
                        </a>
                    </p>
                </td>
            </tr>
        </table>
    </center>
</TMPL_IF>


<TMPL_IF TRACK>
    <center>
        <table border=0>
            <tr>
                <td align="center">
                    <h2>
                        <TMPL_VAR SAVE_TRACKING.SAVE_ALL_OK>
                    </h2>
                    <p>
                        <TMPL_VAR SAVE_TRACKING.SAVE_MESSAGE>
                    </p>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <p>
                        <a id="btnok" data-role="button" data-inline="true" data-mini="true" data-icon="check" onclick="location.href='./index.cgi'">
                            <TMPL_VAR SAVE.SAVE_BUTTON_OK>
                        </a>
                    </p>
                </td>
            </tr>
        </table>
    </center>
	<script>
    </script>
</TMPL_IF>

<TMPL_IF MIGRATION>
    <center>
        <table border=0>
            <tr>
                <td align="center">
                    <h2>
						<FONT COLOR="blue">
							<TMPL_VAR MIGRATION.MIGRATE_OK>
						</FONT>
                    </h2>
                    <p>
                        <TMPL_VAR MIGRATION.MIGRATE_MESSAGE>
                    </p>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <p>
                        <a id="btnok" data-role="button" data-inline="true" data-mini="true" data-icon="check" href="./index.cgi">
                            <TMPL_VAR SAVE.SAVE_BUTTON_OK>
                        </a>
                    </p>
                </td>
            </tr>
        </table>
    </center>
	<script>
    </script>
</TMPL_IF>


